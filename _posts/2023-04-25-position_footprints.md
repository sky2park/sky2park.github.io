---
layout:       post
title:        키보드 만들기 네 번째 - 풋프린트 배치하기
categories:   [custom keyboard]
tags:         [제작기]
description:  '풋프린트를 배치해 봅시다.'
---

오늘은 그려놓은 sch 파일, 즉 논리 회로도를 바탕으로 실제 풋프린트를 배치해 볼 겁니다.

풋프린트를 배치하는 작업은 생각보다 꽤 시간이 오래 걸리고, 귀찮은 작업입니다. 처음 할때는 여기에만 거의 일주일을 넘게 쓴 것 같네요. 이 지루한 작업은 여러 개의 작은 단계로 나눌 수 있습니다.

1. 심볼에 풋프린트 할당
2. 풋프린트 배치
3. 배선과 비아로 라우팅
4. 엣지컷(테두리) 만들기
5. GND 채움 영역 추가

먼저 keyboard-layout-editor에 저장된 레이아웃을 확인하겠습니다. 이 레이아웃을 토대로 풋프린트를 배치할 거라, 풋프린트 배치 작업을 할 때는 KLE를 많이 참고하게 됩니다.

![pherk60-v2](https://user-images.githubusercontent.com/38902150/233842562-b8f31508-1192-4893-95cb-98e38115ea19.png)

풋프린트를 배치하는 작업 전까지는 KLE를 자주자주 수정해도 큰 상관이 없습니다. 배치 후에 혹시나 KLE를 변경할 일이 생긴다면, 조금 귀찮아지게 될 수도 있습니다. 혹시 KLE에서 추가되었거나 빠진 키가 있다면, sch 파일에서도 똑같이 스위치 갯수를 맞추어 줍니다. 저는 처음 레이아웃에서 키가 조금 더 추가되어서, 스위치도 똑같이 추가해 주었습니다.

이 키들에 숫자를 붙여줄 겁니다. 쉬프트 레지스터 하나에는 스위치 8개가 붙을 수 있다고 기록한 적 있습니다. 키 배치를 보니 2열씩 하나의 시프트 레지스터에 연결해 주고, 제일 아래 열을 하나의 시프트 레지스터에 연결해 주면 딱 맞을 것 같네요.

![pherk60-v2 스위치 배치](https://user-images.githubusercontent.com/38902150/233846261-4d4a27d5-ceb8-4b38-a04f-44f33e8361d8.png)

이 숫자의 의미는 sch 파일에서의 스위치 넘버입니다. 0부터 7까지 하나의 시프트 레지스터, 8부터 15까지, 16부터 23까지, 이런 식으로 쭉쭉 가서 마지막 56부터 62까지. 총 8개의 시프트 레지스터, 63개의 스위치가 이런 식으로 배치되도록 풋프린트 배치를 잡을 겁니다. 모으는 이유는 간단합니다. 배선 연결을 쉽게 하기 위함입니다. 시프트 레지스터에 연결되어야 하는 스위치의 위치가 멀면 멀수록, 배선은 복잡해집니다. 0부터 시작한 이유는 저의 sch 파일의 스위치 넘버가 0부터 시작하기 떄문입니다. sch 파일의 스위치 넘버를 보면서 0으로 시작할지, 1로 시작할지를 정하면 됩니다.

이제 sch 파일을 다시 열어서, 상단 메뉴의 풋프린트 할당 도구 실행 버튼을 클릭합니다. 회로도 기호와 풋프린트 기호, 링크 기호가 있는 아이콘입니다.

![풋프린트 할당 도구 실행](https://user-images.githubusercontent.com/38902150/233942543-bbcab2fd-5857-49f7-a202-e2e28f54dea1.png)

![풋프린트 할당 도구](https://user-images.githubusercontent.com/38902150/233943417-e9c9aa12-f6a3-45a5-a174-757bb8774936.png)

여기서 심볼, 즉 논리회로도 기호에 풋프린트를 할당하면 됩니다. R_Pack04 심볼은 Resistor_SMD:R_Array_Convex_4x0603를 할당, 74HC165 심볼은 Package_SO:TSSOP-16_4.4x5mm_P0.65mm를 할당, MODULE_SEEEDUINO_XIAO는 RP2040_pinheader:rp2040를 할당해 줍니다. 그러면 SW_Push 심볼인 스위치만 남게 됩니다.

왼쪽 풋프린트 라이브러리에서 MX_Hotswap을 선택합니다. 그러면 오른쪽 필터링된 풋프린트에 스위치 풋프린트 목록이 필터링되어 나타납니다. 아까 번호를 붙여준 레이아웃을 확인하면서, 각 키캡 사이즈에 해당하는 풋프린트를 매핑하여 주면 됩니다. ReversedStabilizers는 스태빌라이저 철심 방향이 반대로 된 풋프린트입니다. 보통 가장 아래열(스페이스바)에 사용하거나, 다른 스테빌라이저와 간섭이 있을 때 사용하면 좋을 것 같습니다.

모두 설정했으면 확인을 누릅니다. 그리고 sch 파일을 저장한 다음 닫고, pcb 파일을 엽니다. 빈 pcb 편집기가 열리면, F8 키를 눌러 회로도에서 PCB 업데이트 팝업을 엽니다.

![F8](https://user-images.githubusercontent.com/38902150/233947586-06b4376d-2b29-4cf1-814e-e8fff96e1351.png)

![회로도에서 PCB 업데이트](https://user-images.githubusercontent.com/38902150/233947726-f778c384-c408-45ad-b947-02b27cc20e58.png)

열린 팝업에서 오류나 경고가 없어야 합니다. 아, 제가 작업한 풋프린트가 핀 3개를 사용하지 않기 때문에 그걸 뻈는데, 이 오류는 있어도 상관없습니다. 만약 이를 제외한 다른 오류가 있다면 풋프린트 할당 도구에서 할당이 제대로 안 되었거나, 도선 연결이 안 되었거나, 여하튼 sch 파일에 오류가 있는 겁니다. PCB 업데이트 버튼을 누릅니다. 그러면 pcb 편집기에 풋프린트가 주르륵 나타납니다. 어차피 다 새로 배치해야 하니, 대충 아무 곳이나 위치시키면 됩니다. 이 PCB 업데이트 작업은 혹시 배치 중 sch 파일을 수정하였을 때마다, 수정한 내용을 반영하기 위해 반드시 해 주어야 합니다.

![풋프린트 배치](https://user-images.githubusercontent.com/38902150/233948734-0253a8df-e811-4f11-9bf4-e42d420ce3a4.png)

페이지가 좀 작아서, 페이지 설정에서 A3으로 페이지 크기를 키워주었습니다. 일단 스위치부터 배치해 보겠습니다. 스위치를 오차 없이 예쁘게 배치하기 위해, 그리드 간격 편집이 필요합니다. 상단 '그리드: xxx' 라고 되어 있는 드롭다운을 클릭하여 사용자 그리드 편집을 누른 다음, 사용자 정의 그리드의 x와 y에 2.38125mm를 입력하여 줍니다.

혹시 단위가 mm로 설정되어있지 않다면 왼쪽 툴바에서 mm 단위 사용을 선택하면 됩니다.

![사용자 정의 그리드](https://user-images.githubusercontent.com/38902150/233949630-9f24583f-99df-40af-ad7d-5fc861bebec2.png)

하는김에 배선과 비아 사이즈도 미리 설정해 주겠습니다. 배선이나 비아 드롭다운을 클릭하여 편집 팝업을 연 다음, 아래 추가 버튼을 누른 다음에 각각 배선 두께는 0.254mm, 0.381mm를 넣어 주고, 비아는 직경 0.6mm, 홀 0.3mm를 넣어 주고 확인을 누르면 됩니다.

![배선,비아 편집](https://user-images.githubusercontent.com/38902150/233949848-4558d789-b39e-4f85-9c8a-bd2299c7de9b.png)

그리드를 아까 설정한 사용자 그리드로 바꾸고, 첫 스위치부터 KLE 레이아웃을 따라 배치해 주면 됩니다. 스위치의 가운데 큰 원에 마우스를 올린 다음, 클릭하지 않고 M을 누르면 딱 스위치 풋프린트의 중앙에 커서가 간 채로 풋프린트를 이동할 수 있습니다. 만약에 M을 눌렀을 때 큰 원에 마우스가 고정되지 않는다면 ESC를 눌러 취소하고 다시 M을 눌러 중앙에 커서를 고정시켜야 합니다. 안그러면 정위치에 배치할 수 없어요.

![스위치 풋프린트](https://user-images.githubusercontent.com/38902150/233954453-f02efeb8-39b9-4597-adc5-47420ff54d3b.png)

스위치 풋프린트를 배치하려고 보면 SWx 부분이 뒤집혀 있는걸 볼 수 있는데요. 정상이니 신경쓰지 말고 하시면 됩니다.

스위치를 모두 배치하고 나면 시프트 레지스터와 저항, 그리고 MCU를 배치해야 합니다. 이 부품들은 기판의 후면에 SMD로 붙게 되도록 설계하였습니다. SMD는 표면에 부품을 땜질해서 붙이는 기법인데요. DIP처럼 회로도를 관통하는 핀 없이 부품을 한쪽 면에 떔질하게 되므로, 부품을 작게 만들 수 있다고 하네요. 아무튼 기판 후면에 붙도록 해야 한다고 했으므로, 남은 부품들을 모두 선택하여 F 키를 눌러 배치면 변경 / 반전 처리를 해 줍니다.

기본적으로 풋프린트는 빨간색이 전면(Front), 파란색이 후면(Back) 레이어를 의미합니다. 빨간색 부품들이 파란색으로 바뀌면 반전이 됐구나 하고 생각하시면 됩니다.

![배치면 반전](https://user-images.githubusercontent.com/38902150/233955901-d9dc51cb-b833-4893-acfc-610bc31fdd7f.png)

시프트 레지스터와 저항은 올림픽에서 보는 시상대 모양처럼, 또는 볼록할 철(凸) 모양처럼 배치하였습니다. 다른 여러 방법이 있겠지만, 이렇게 하였을 때 VCC 연결이 깔끔하게 되더라구요. 시프트 레지스터를 사용한 다른 PCB 기판을 보면서 참고하여 그렸는데, 이렇게 배치하는 것이 가장 깔끔하게 배선 연결이 잘 되었기 때문이 아닌가 합니다. 

![시프트 레지스터와 저항 배치](https://user-images.githubusercontent.com/38902150/233968095-7ad1edf4-78b5-496d-8b41-a239347c36c5.png)

하나의 시프트 레지스터에 저항 두개가 붙는데, 왼쪽 툴바에서 기판 연결선 표시가 활성화되어있지 않다면 활성화한 다음 배선 연결 가이드라인을 보고 배치하면 됩니다. R키를 누르면 풋프린트가 회전하므로, 회전이 필요하다면 저항을 회전시키면서 적절한 위치를 찾습니다. 그래도 위치가 도저히 안 나오면 어쩔 수 없이 sch 파일을 열어서 도선을 다시 연결하거나 해야 합니다.

![풋프린트 배치 완료](https://user-images.githubusercontent.com/38902150/233967738-00d3b6f9-d4b2-47f1-b786-87551382fec0.png)

풋프린트 배치가 모두 완료되었습니다. 조금 안타까운 말이지만, 여기까지는 쉬운 편에 속합니다. 가장 까다로운 배선 연결이 남아있기 때문인데요. 기판 연결선 표시를 활성화하여 배선 가이드를 켠 다음, 배선을 연결해 줍니다. 전원 관련된 3V3이나 VCC 선은 굵은 배선(0.381)으로 하고, 그 외의 것은 0.254로 해 주면 됩니다. 전체적으로 비아의 갯수를 줄일 수록 좋습니다. 그리드 사이즈는 1mils(0.0254mm)가 깔끔하게 연결되는 것 같지만. 할때마다 달라져서 사실 크게 중요하지는 않습니다. 이건 별도의 팁이랄게 없습니다. 그냥 여러번 실패해 가면서 몸에 익히는 방법밖에는 없다고 하는게 제일 좋네요.

![배선 완료](https://user-images.githubusercontent.com/38902150/234171378-1fa69567-af0a-4461-82c1-42ec4249f85c.png)

이제 엣지 컷, PCB의 모양을 정해 줍니다. 그냥 깔끔하게 직사각형으로 하겠습니다. 사용자 그리드로 설정을 하고 전체 부품을 그리드에 맞춰 정렬한 다음, 오른쪽 형상에서 Edge.cuts를 선택하고, 역시 오른쪽 툴바에서 직사각형 그리기 버튼을 클릭하여 스위치를 딱 감싸는 영역으로 사각형을 설정해 주었습니다. 그 후 그려진 사각형의 속성에 들어가서 0.5mm씩 안쪽으로 넣어줍니다. 이론상 딱 맞으면 실제 부품 조립을 할 때 물려서 안 들어가는 경우가 생기더라구요.

![엣지컷](https://user-images.githubusercontent.com/38902150/234171714-0ff81dd9-6bac-475e-9703-1738eb4ad0ab.png)

상하좌우 각 0.5mm씩 안으로 넣어준 이 영역이 최종 pcb 기판으로 제작되는 영역입니다. 이제 마지막 작업이 남았습니다. GND 채움 영역을 추가해서 따로 노는 GND 신호들을 모두 일치시키면 되겠습니다. 구리 영역(F.Cu 또는 B.Cu)를 선택하고, 오른쪽 툴바에서 채움 영역 추가를 누르면 됩니다. 뜨는 팝업에서 전/후면 구리영역을 모두 선택하고, GND를 눌러 채웁니다. 그냥 깔끔하게 가득 채울 수도 있는데, 저는 그냥 예뻐 보이게 하기 위해 해치 패턴으로 추가하였습니다. 

![채움 영역 추가](https://user-images.githubusercontent.com/38902150/234172525-48f8c3a9-d01d-45f4-ae61-8834691641fe.png)

확인을 누르면 자동으로 영역 채우기가 실행되는데, 만약 아무 반응이 없다면 키보드의 B 키를 누르거나 편집 - 모든 영역 채우기를 눌러주면 됩니다.

여기까지 끝났다면, 최종 확인을 해 볼 시간입니다. 메뉴의 검사 - 디자인 규칙 검사기를 선택하여 오류가 없는지 DRC를 해 봅니다. DRC 실행을 누르고, 뜨는 오류와 경고를 최대한 없애줍니다. 오류는 반드시 없애야 하고, 경고는 때에 따라 없애지 않아도 됩니다. 모든 오류와 경고에 대한 수정은 구글링으로 해결하였습니다.

DRC까지 모두 해결하고 나면, 드디어 모든 작업이 완료되었습니다. 이 포스트를 처음 작성하기 시작한게 22일 밤인데, 완성하는데 3일이 걸렸네요. 다음 포스트에서는 PCB를 주문하고, 보강판을 포함한 하우징을 만들어 보겠습니다.

![완성](https://user-images.githubusercontent.com/38902150/234176272-483412cb-9068-4451-bdf8-3f96abd8c605.png)

> 참고 : https://github.com/SonalPinto/purple-owl