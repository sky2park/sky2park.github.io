---
layout:       post
title:        키보드 만들기 세 번째 - kicad 회로도 그리기
categories:   [custom keyboard]
tags:         [제작기]
description:  'Kicad 회로도를 그려봅니다.'
---

지난번 포스트에서는 Kicad 환경 설정을 끝냈습니다. 이제 직접 회로도를 그릴 시간입니다.

제가 이걸 공부하기 시작했을 때, 어떤 항목부터 공부를 시작했는지는 잘 기억이 나지 않습니다. 그냥 깃헙에 올라온 다른 여러 오픈된 키보드 회로도 프로젝트를 많이 공부했던 것 같고, 키보드를 스캐닝하는 방법에 대한 자료를 여러 개 찾아보았던 기억 정도만 남아 있네요.

아무튼, 회로도를 그리기에 앞서 정해야 할 게 있습니다. 키보드 레이아웃은 저번에 정했고, 키보드 스캐닝 방식을 정해야 합니다. 키보드 스캐닝 방식은 'mcu가 키보드의 무슨 키가 눌렸는지 알아내는 방법'이라고 보면 될 것 같네요.

대부분의 키보드에 사용되는 스캐닝 방식은 키보드 매트릭스입니다. 키보드를 열과 행으로 나누고, 각 행과 열을 mcu의 핀아웃에 하나씩 연결한 다음, 행 x와 열 y에 전기 신호가 들어오면 키보드의 F를 누른것이다! 뭐 이렇게 인식하는 거죠. 저는 여기서 키보드 매트릭스를 다루진 않을 겁니다. 그렇지만 키보드 스캐닝 기법 중 가장 대중적인 방식이니, 구글링해 보면 어렵지 않게 찾을 수 있을 겁니다.

제가 사용할 방법은 8-bit parallel-in/serial out shift register인 74hc165 부품을 사용한 방식입니다. 키보드 매트릭스 보다는 직관적이지 않고 조금 어려울 수 있는데, 제가 이 방식을 선택한 이유가 있습니다. 먼저 74hc165가 뭔지 알아봅시다.

![74HC165](https://user-images.githubusercontent.com/38902150/232781885-0d1b5aa7-3c68-493b-9212-2047de6de48b.png)


74hc165는 병렬 입력, 직렬 출력을 지원하는 8비트 쉬프트 레지스터입니다. 총 16개의 핀이 있는데, 7번 핀을 제외한 핀을 모두 사용합니다. 핀 매핑은 다음과 같습니다.

>1번 핀 : Latch  
>2번 핀 : 클럭  
>3번~6번, 11번~14번 핀 : 병렬 입력 핀(키보드 스위치와 연결됩니다)  
>8번, 15번 핀 : GND  
>9번 핀 : 직렬 출력(Data)  
>10번 핀 : DS(쉬프트 레지스터를 여러 개 연결할때 사용합니다)  
>16번 핀 : VCC

3~6, 11~14번 핀으로 입력된 신호가 9번으로 직렬 out됩니다. out 될 때의 순서는 11, 12, 13, 14, 3, 4, 5, 6인데요, 키보드 스캐닝을 할 때에는 한 비트씩 읽고, 이렇게 한 비트씩 읽을 때에는 역으로 읽습니다. 6, 5, 4, 3, 14, 13, 12, 11 순서로 읽게 된다는 뜻입니다.

10번 핀은 여러 개의 쉬프트 레지스터를 연결했을 때 '다음 쉬프트 레지스터에서 넘어오는 값'입니다. 두개를 연결하면, 첫 번째 쉬프트 레지스터의 직렬 출력이 먼저 되고, 다음 8비트에 두 번째 쉬프트 레지스터의 직렬 출력값이 나타납니다.

1번 핀, 2번 핀은 제어 핀입니다. 16번은 VCC, 8번과 15번 핀은 GND입니다. MCU에 연결될 핀은 1번, 2번, 9번, 16번 핀이 되겠네요.

이 정도만 알면 일단 키보드 회로도를 그릴 수 있습니다. 이제 Kicad에 직접 한번 그려 보겠습니다. Kicad를 실행하고, 생성한 프로젝트의 sch 파일을 실행하여 회로도 파일을 엽니다. 오른쪽 툴바의 심볼 추가 버튼을 클릭하여 심볼 선택 팝업을 열었습니다. 검색창에 74hc165를 입력하여 74hc165 심볼을 선택합니다.

![심볼 선택](https://user-images.githubusercontent.com/38902150/232790462-9a5a1241-6c7b-476f-84a7-b8a11ba35775.png)

심볼이 선택되면 배치할 적당한 위치를 잡습니다. 6번 핀부터 11번 핀까지 순서대로 읽는다고 했기 때문에, 6번 핀이 제일 왼쪽에 있으면 좋을 것 같다는 생각이 들었습니다. X를 눌러 뒤집고, R을 눌러 입력 핀이 아래로 가게 한 다음 클릭하여 화면에 배치하였습니다.

![74hc165](https://user-images.githubusercontent.com/38902150/232791122-5c240084-cd7d-437b-a79a-cfdb6f7b5e26.png)

쉬프트 레지스터 배치는 했고, 스위치를 배치해 봅시다. 키보드 스위치는 말 그대로 전류를 흐르게 해 주는 스위치입니다. 스위치를 누르면 흐르고, 떼면 끊깁니다. 그래서 일반 스위치와 같은 기호를 쓰면 될 것 같네요. 심볼 선택 팝업을 열고 SW_PUSH를 검색하여 스위치를 선택합니다.

![sw_push](https://user-images.githubusercontent.com/38902150/232792247-94b09642-c5e3-44cf-b562-5087923bf594.png)

적당히 배치한 다음에 복사 붙여넣기로 총 8개의 스위치를 만듭니다. 하나의 쉬프트 레지스터에 연결할 수 있는 스위치는 8개이기 때문입니다.

스위치가 모두 배치되었다면 저항을 배치합니다. 왜 배치하는지는 정확히 모르겠는데, 아마 과전류를 방지하기 위함이 아닐까 합니다. 스위치 하나당 한개의 저항이 연결되어야 하고, 8개의 스위치니 저항도 8개가 필요합니다. 8개를 일일이 넣을수도 있겠지만, 어레이 저항을 써도 됩니다. 4개짜리 어레이 저항 두개를 추가하면 되겠네요. R_Pack04 심볼을 찾아서 두개 배치합니다.

![하나의 쉬프트 레지스터에 사용되는 부품들](https://user-images.githubusercontent.com/38902150/232794375-bac6bbf9-dae6-411c-8edb-57f5c5081d75.png)

이제 여기에 도선을 따서 이어주어야 합니다. 오른쪽 툴바에서 도선 추가를 누르거나 W 단축키를 누르면 됩니다. 쉬프트 레지스터의 병렬 입력 핀아웃 8개에 각 스위치를 연결해 주고, 그 도선에 병렬로 저항을 이어주면 됩니다. 이건 논리 회로도라 선을 뭐 예쁘게 딸 필요는 없는데, 그래도 알아보기 쉬우면 나중에 수정 사항이 발생할 때 수정하기 쉽습니다. 생각보다 수정 소요는 많이 발생합니다. 그러니까 보기 쉽게 선을 이어줍니다. 저는 이렇게 이어주었습니다.

![도선연결](https://user-images.githubusercontent.com/38902150/232795933-abbe5065-f4dd-4292-ac47-796389707a62.png)

처음 회로도를 그릴 때는 다른 프로젝트를 참고해서 그렸고, 그 후에 제 나름대로 이것저것 변경을 했는데, 결국 오류나 가독성 등의 이유로 처음 참고했던 다른 프로젝트의 회로도를 거의 따라가게 되더라구요. 어찌보면 가정 최적화된 도선이 아닐까 싶기도 하네요.

부품끼리 도선을 모두 연결했다면, 이제 3V와 GND를 연결해줄 차례입니다. 심볼 선택에서 3V3과 GND를 검색하여 추가해 주고, 저항과 쉬프트 레지스터, 스위치에 연결해 줍니다. 쉬프트 레지스터에는 앞서 적은 핀아웃 매핑중 VCC에 3V3, GND에 GND를 연결해 주고, 저항은 도선과 연결된 반대쪽에 3V3을, 스위치는 도선과 연결된 반대쪽에 GND를 연결해 주면 됩니다.

쉬프트 레지스터의 7번 핀아웃에는 별도의 연결이 없습니다. 우측 툴바에서 연결 없음 추가를 선택하고 7번 핀아웃에 추가해 줍니다. 여기까지의 회로도는 다음과 같습니다.

![파워 연결 후](https://user-images.githubusercontent.com/38902150/232798675-53b3b3b1-6b00-4461-9a7c-37e41678bee4.png)

쉬프트 레지스터의 1번 핀에는 Latch, 2번 핀에는 클럭이 연결되어야 합니다. 이 핀아웃은 MCU와 연결되는데, 일단 라벨을 붙여 놓겠습니다. 툴바에서 전역 라벨 추가를 누른 다음 라벨명에 CLK를 입력하여 생성한 다음 2번에 붙여 줍니다. 한번더 전역 라벨을 추가하여 라벨명은 LD를 입력하고 1번에 붙입니다.

이렇게 하면 8개의 스위치 입력을 커버하는 회로도가 완성되었습니다.

![8개의 스위치 입력 커버](https://user-images.githubusercontent.com/38902150/232800390-7499f670-b32e-402e-a9ca-af9f79eeac3d.png)

이제 이 회로도를 여러 개 복사하여 입력받고자 하는 스위치의 숫자만큼 연결해 주면 됩니다. 일단 하나만 복사해서 두개의 쉬프트 레지스터를 연결해 보겠습니다. 간단합니다. 회로도 전체를 복사 붙여넣기한 다음, 첫 번째 쉬프트 레지스터의 10번 핀과 두 번째 쉬프트 레지스터의 9번 핀을 도선으로 연결해 주면 됩니다.

![두개 연결](https://user-images.githubusercontent.com/38902150/232801143-92f3c3fb-55ea-4558-a4ef-cdc9323827cb.png)

10번과 9번이 연결된게 보이죠. 알아서 쉬프트 레지스터, 저항, 스위치의 네이밍도 순서대로 붙고 있네요. 이렇게 여러 개를 연결해 줄 수 있습니다. 키보드에 필요한 스위치 갯수만큼 회로도를 복사해 줍니다.

제가 앞선 포스트에서 그렸던 키보드 레이아웃에서 몇 가지가 변했습니다. v1을 만들어 쓰면서 불편한 점이나 고치기 어려운 습관 등을 알게 되어서 v2에서의 레이아웃을 다시 그렸는데요. 이걸 v2라고 이름 붙이는게 맞나 싶을 정도로 좀 많이 변하긴 했는데, 암튼 레이아웃에서 스위치가 몇 개나 필요한지 알아내면 됩니다. 저는 61키네요. 61/8 = 7.625니까, 총 8번 복사 붙여넣기를 하면 되네요.

![pherk60-v2](https://user-images.githubusercontent.com/38902150/232801878-16b8cc85-32ec-435b-9a43-2da471a32af8.png)

연결하다 보면 회로도 시트를 넘어갈 때가 있어요. 파일 - 페이지 설정에서 페이지를 더 크게 설정할 수 있습니다. 기본은 A4인데, A3로 넓혀 주었습니다.

마지막 쉬프트 레지스터의 경우는 모든 입력 핀아웃에 스위치가 연결되지 않을 때가 더 많습니다. 정확히 8의 배수로 스위치 갯수를 맞추지 않기 때문인데, 그럴 경우에는 이렇게 하면 됩니다. 마지막 DS 핀에는 다음 쉬프트 레지스터가 없기 때문에 GND를 연결하고, 연결하지 않는 스위치는 그대로 GND로 빼주면 되고, 연결하지 않는 저항은 연결 없음을 붙여 주면 됩니다.

![모두 연결하지 않은 쉬프트 레지스터](https://user-images.githubusercontent.com/38902150/232809190-8ac50c06-7f5a-49ce-bff7-46f9cd70109a.png)

이제 MCU 기호도 추가해 봅시다. MCU는 저번에 Xiao RP2040을 사용하기로 정했었고, 직전 포스트에서 심볼 라이브러리까지 추가해 주었었습니다. 그 심볼을 바로 추가해 주면 됩니다. 추가 후 GND와 3V3을 다시 추가해서 각각 13번, 12번 핀아웃에 연결해 줍니다.

이제 MCU에 클럭, LD, DATA 핀만 연결하면 회로도 작성이 모두 끝납니다. MCU의 1번 핀부터 11번 핀 중 아무거나 세개 골라서 CLK, LD 라벨을 추가하여 붙여 줍니다. DATA 라벨은 두개를 추가합시다. 하나는 MCU에, 그리고 다른 하나는 첫 번째 쉬프트 레지스터의 9번 핀아웃에 붙여주면 됩니다.

![MCU 연결](https://user-images.githubusercontent.com/38902150/232938786-a99a3bb1-175c-48bb-939b-a53c116d2dfb.png)

완성입니다. 생각보다 오래 걸리지 않았네요. 아무래도 비슷한 형태의 덩어리를 복붙하면서 만들다 보니 그렇게 된 것 같습니다. 

제가 앞에서 쉬프트 레지스터 방식을 선택한 이유가 있다고 했습니다. 그 이유는 MCU에 연결되는 핀 갯수를 보면 알 수 있습니다. 쉬프트 레지스터 방식을 사용하면, VCC와 GND를 빼고 핀 3개만 있으면 됩니다. 만약 키보드 매트릭스 스캔 방식을 사용했다면 행의 갯수 + 열의 갯수만큼 필요했을 겁니다. 핀 갯수를 줄여 더 작은 MCU를 선택하기 위함이었다고 볼 수 있습니다.

이렇게 회로도를 잘 그려 놓으면 PCB에 풋프린트를 배치할 때 가장 어렵고 귀찮은 작업은 배선 연결시에 많은 도움이 됩니다. 다음 포스트에서는 풋프린트를 배치해 보겠습니다.

![전체 회로도](https://user-images.githubusercontent.com/38902150/232938954-d7159a1f-6d79-482e-9912-f397c9373beb.png)